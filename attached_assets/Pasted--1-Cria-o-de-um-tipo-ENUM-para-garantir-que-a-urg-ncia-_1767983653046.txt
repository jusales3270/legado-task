-- 1. Criação de um tipo ENUM para garantir que a urgência seja sempre uma dessas opções
create type urgency_level as enum ('Low', 'Normal', 'High', 'Critical');
create type user_role as enum ('admin', 'client');

-- 2. Tabela de Perfis (Vinculada ao Auth do Supabase)
create table public.profiles (
  id uuid references auth.users not null primary key,
  email text,
  role user_role default 'client', -- Todo mundo entra como cliente por padrão
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Tabela de Tarefas (Seu Kanban/Entrada)
create table public.tasks (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  client_id uuid references public.profiles(id) not null,
  
  -- Dados do Formulário
  file_url text not null, -- Aqui entra o link do R2/S3
  file_name text,         -- Nome original do arquivo para referência
  urgency urgency_level default 'Normal',
  due_date date,
  description text,
  
  -- Controle Interno
  status text default 'Inbox', -- Inbox, Doing, Done
  is_archived boolean default false
);

-- 4. Habilitar Row Level Security (Segurança)
alter table public.profiles enable row level security;
alter table public.tasks enable row level security;

-- 5. Políticas de Segurança (POLICIES)

-- PERFIL: Todos podem ver seus próprios perfis. Admin vê tudo.
create policy "Users can view own profile" 
  on profiles for select 
  using ( auth.uid() = id );

-- TAREFAS: Clientes podem INSERIR (Upload).
create policy "Clients can insert tasks" 
  on tasks for insert 
  with check ( auth.uid() = client_id );

-- TAREFAS: Clientes podem VER apenas suas próprias tarefas (Histórico).
create policy "Clients can view own tasks" 
  on tasks for select 
  using ( auth.uid() = client_id );

-- TAREFAS: Admins podem FAZER TUDO (Ver, Editar, Deletar).
-- (Precisamos de uma função helper para checar se é admin, veja abaixo)

-- 6. Trigger para criar perfil automaticamente quando o usuário faz Signup
create or replace function public.handle_new_user() 
returns trigger as $$
begin
  insert into public.profiles (id, email, role)
  values (new.id, new.email, 'client');
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();